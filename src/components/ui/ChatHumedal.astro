<div class="chat-widget" data-chat-widget>
  <button
    class="chat-trigger"
    type="button"
    aria-haspopup="dialog"
    aria-controls="chat-humedal-modal"
    aria-expanded="false"
    data-chat-open
  >
    Preguntar al asistente
  </button>

  <div class="chat-modal" id="chat-humedal-modal" role="dialog" aria-modal="true" aria-labelledby="chat-title" aria-hidden="true">
    <div class="chat-overlay" data-chat-close></div>
    <section class="chat-panel">
      <header class="chat-header">
        <div>
          <h2 id="chat-title">Asistente del Humedal El Yali</h2>
          <p>Responde dudas sobre el humedal y Yali Salvaje.</p>
        </div>
        <button class="chat-close" type="button" aria-label="Cerrar chat" data-chat-close>
          Cerrar
        </button>
      </header>

      <div class="chat-messages" data-chat-messages>
        <article class="msg-wrap msg-wrap-assistant">
          <span class="msg-avatar msg-avatar-assistant" aria-hidden="true">IA</span>
          <div class="msg-stack">
            <p class="msg-role">Asistente</p>
            <div class="msg msg-assistant">
              Hola. Puedo ayudarte con preguntas sobre biodiversidad, ubicacion e informacion del Humedal El Yali.
            </div>
          </div>
        </article>
      </div>

      <form class="chat-form" data-chat-form>
        <label for="chat-input" class="sr-only">Escribe tu pregunta</label>
        <textarea
          id="chat-input"
          name="message"
          rows="3"
          maxlength="600"
          placeholder="Ejemplo: Que aves migratorias se observan en El Yali?"
          required
        ></textarea>
        <div class="chat-actions">
          <small data-chat-status></small>
          <button type="submit" data-chat-send>Enviar</button>
        </div>
      </form>
    </section>
  </div>
</div>

<style>
  .chat-widget {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    z-index: 120;
  }

  .chat-trigger {
    border: 1px solid rgba(255, 255, 255, 0.26);
    background:
      linear-gradient(145deg, rgba(20, 83, 45, 0.95), rgba(15, 62, 35, 0.95));
    color: #fff;
    border-radius: var(--radius-pill);
    padding: 0.85rem 1.2rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow:
      0 12px 28px rgba(5, 20, 12, 0.35),
      inset 0 1px 0 rgba(255, 255, 255, 0.28);
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .chat-trigger:hover {
    transform: translateY(-2px);
    box-shadow:
      0 18px 34px rgba(5, 20, 12, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.32);
  }

  .chat-modal {
    position: fixed;
    inset: 0;
    z-index: 130;
    display: grid;
    place-items: end;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.28s ease;
  }

  .chat-modal.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .chat-overlay {
    position: absolute;
    inset: 0;
    background: rgba(1, 5, 3, 0.58);
    backdrop-filter: blur(2px);
  }

  .chat-panel {
    position: relative;
    background:
      linear-gradient(162deg, rgba(255, 255, 255, 0.98), rgba(244, 248, 245, 0.98));
    width: min(100vw - 1rem, 470px);
    max-height: min(82vh, 700px);
    margin: 0.5rem;
    border-radius: 1.15rem;
    border: 1px solid rgba(16, 36, 24, 0.12);
    box-shadow:
      0 30px 60px rgba(6, 18, 11, 0.35),
      0 6px 16px rgba(6, 18, 11, 0.24),
      inset 0 1px 0 rgba(255, 255, 255, 0.65);
    display: grid;
    grid-template-rows: auto 1fr auto;
    overflow: hidden;
    transform: translateY(14px) scale(0.98) rotateX(2deg);
    transform-origin: bottom right;
    transition: transform 0.28s cubic-bezier(0.22, 0.61, 0.36, 1);
  }

  .chat-modal.is-open .chat-panel {
    transform: translateY(0) scale(1) rotateX(0deg);
  }

  .chat-header {
    padding: 0.95rem 1rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.09);
    display: flex;
    align-items: start;
    justify-content: space-between;
    gap: 1rem;
    background: linear-gradient(180deg, rgba(225, 242, 230, 0.75), rgba(225, 242, 230, 0.42));
  }

  .chat-header h2 {
    margin: 0;
    font-size: 1.08rem;
  }

  .chat-header p {
    margin: 0.2rem 0 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .chat-close {
    border: 1px solid rgba(0, 0, 0, 0.12);
    background: rgba(255, 255, 255, 0.8);
    color: var(--muted);
    cursor: pointer;
    border-radius: var(--radius-pill);
    font-weight: 600;
    padding: 0.35rem 0.75rem;
  }

  .chat-messages {
    overflow: auto;
    padding: 1rem;
    display: grid;
    gap: 0.95rem;
    background:
      radial-gradient(circle at 0 0, rgba(203, 228, 211, 0.45), transparent 42%),
      radial-gradient(circle at 100% 100%, rgba(219, 233, 255, 0.35), transparent 45%),
      var(--paper-2);
  }

  .msg-wrap {
    display: grid;
    grid-template-columns: 30px minmax(0, 1fr);
    align-items: start;
    gap: 0.55rem;
    max-width: 95%;
  }

  .msg-wrap-user {
    margin-left: auto;
    grid-template-columns: minmax(0, 1fr) 30px;
  }

  .msg-wrap-assistant {
    margin-right: auto;
  }

  .msg-stack {
    display: grid;
    gap: 0.35rem;
  }

  .msg-wrap-user .msg-stack {
    justify-items: end;
  }

  .msg-avatar {
    width: 30px;
    height: 30px;
    border-radius: var(--radius-round);
    display: grid;
    place-items: center;
    font-size: 0.66rem;
    font-weight: 800;
    letter-spacing: 0.05em;
    align-self: end;
  }

  .msg-avatar-assistant {
    background: linear-gradient(145deg, #dbeafe, #c7f3df);
    border: 1px solid rgba(28, 52, 91, 0.18);
    color: #173153;
  }

  .msg-avatar-user {
    background: linear-gradient(145deg, #ecfdf5, #d4fbe5);
    border: 1px solid rgba(14, 74, 39, 0.18);
    color: #114226;
  }

  .msg-role {
    margin: 0;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.09rem;
    color: var(--muted);
    font-weight: 700;
  }

  .msg {
    padding: 0.72rem 0.82rem;
    border-radius: 0.82rem;
    line-height: 1.43;
    white-space: pre-wrap;
    max-width: 100%;
  }

  .msg-user {
    background: linear-gradient(145deg, #dcfce7, #c9f3d6);
    border: 1px solid rgba(27, 107, 57, 0.2);
    color: #0f2d19;
    box-shadow:
      0 8px 20px rgba(30, 102, 56, 0.14),
      inset 0 1px 0 rgba(255, 255, 255, 0.5);
    border-top-right-radius: 0.35rem;
  }

  .msg-assistant {
    background: linear-gradient(145deg, #ffffff, #f3f5f8);
    border: 1px solid rgba(8, 14, 20, 0.09);
    box-shadow:
      0 8px 18px rgba(9, 14, 21, 0.08),
      inset 0 1px 0 rgba(255, 255, 255, 0.72);
    border-bottom-left-radius: 0.35rem;
  }

  .msg-typing {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    min-width: 72px;
  }

  .typing-dot {
    width: 0.42rem;
    height: 0.42rem;
    border-radius: var(--radius-round);
    background: rgba(30, 43, 58, 0.55);
    animation: typingPulse 1s infinite ease-in-out;
  }

  .typing-dot:nth-child(2) {
    animation-delay: 0.12s;
  }

  .typing-dot:nth-child(3) {
    animation-delay: 0.24s;
  }

  @keyframes typingPulse {
    0%, 80%, 100% {
      transform: translateY(0);
      opacity: 0.32;
    }
    40% {
      transform: translateY(-2px);
      opacity: 1;
    }
  }

  .chat-form {
    border-top: 1px solid rgba(0, 0, 0, 0.08);
    background: rgba(255, 255, 255, 0.96);
    padding: 0.85rem;
    display: grid;
    gap: 0.6rem;
  }

  .chat-form textarea {
    width: 100%;
    resize: vertical;
    min-height: 84px;
    max-height: 160px;
    border-radius: 0.7rem;
    border: 1px solid rgba(0, 0, 0, 0.15);
    padding: 0.65rem 0.75rem;
    font: inherit;
    background: rgba(255, 255, 255, 0.92);
  }

  .chat-form textarea:focus {
    outline: 2px solid rgba(20, 83, 45, 0.24);
    outline-offset: 1px;
    border-color: rgba(20, 83, 45, 0.35);
  }

  .chat-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
  }

  .chat-actions small {
    color: var(--muted);
    min-height: 1.2em;
  }

  .chat-actions button {
    border: 0;
    border-radius: var(--radius-pill);
    background: var(--accent);
    color: #fff;
    font-weight: 700;
    padding: 0.56rem 1rem;
    cursor: pointer;
    box-shadow:
      0 8px 18px rgba(7, 39, 20, 0.26),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }

  .chat-actions button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (min-width: 960px) {
    .chat-modal {
      place-items: end end;
    }

    .chat-widget {
      right: 1.25rem;
      bottom: 1.25rem;
    }
  }

  @media (max-width: 520px) {
    .msg-wrap {
      max-width: 100%;
      grid-template-columns: 26px minmax(0, 1fr);
      gap: 0.45rem;
    }

    .msg-wrap-user {
      grid-template-columns: minmax(0, 1fr) 26px;
    }

    .msg-avatar {
      width: 26px;
      height: 26px;
      font-size: 0.6rem;
    }
  }
</style>

<script>
  const initChatWidget = (root) => {
    if (!(root instanceof HTMLElement) || root.dataset.chatReady === "true") return;
    root.dataset.chatReady = "true";

    const trigger = root.querySelector("[data-chat-open]");
    const modal = root.querySelector(".chat-modal");
    const closeButtons = root.querySelectorAll("[data-chat-close]");
    const form = root.querySelector("[data-chat-form]");
    const messages = root.querySelector("[data-chat-messages]");
    const textarea = root.querySelector("#chat-input");
    const sendButton = root.querySelector("[data-chat-send]");
    const status = root.querySelector("[data-chat-status]");
    const history = [];
    let openFrameId = 0;
    const scopeAttrName = messages?.firstElementChild
      ?.getAttributeNames()
      .find((name) => name.startsWith("data-astro-cid"));

    const createScopedElement = (tagName, className) => {
      const element = document.createElement(tagName);
      if (className) element.className = className;
      if (scopeAttrName) element.setAttribute(scopeAttrName, "");
      return element;
    };

    const appendMessage = (text, role) => {
      if (!(messages instanceof HTMLElement)) return;
      const wrap = createScopedElement(
        "article",
        `msg-wrap ${role === "user" ? "msg-wrap-user" : "msg-wrap-assistant"}`,
      );

      const avatar = createScopedElement(
        "span",
        `msg-avatar ${role === "user" ? "msg-avatar-user" : "msg-avatar-assistant"}`,
      );
      avatar.textContent = role === "user" ? "TÃš" : "IA";
      avatar.setAttribute("aria-hidden", "true");

      const stack = createScopedElement("div", "msg-stack");

      const roleLabel = createScopedElement("p", "msg-role");
      roleLabel.textContent = role === "user" ? "Tu pregunta" : "Asistente";

      const bubble = createScopedElement(
        "div",
        `msg ${role === "user" ? "msg-user" : "msg-assistant"}`,
      );
      bubble.textContent = text;

      stack.append(roleLabel, bubble);
      if (role === "user") {
        wrap.append(stack, avatar);
      } else {
        wrap.append(avatar, stack);
      }
      messages.appendChild(wrap);
      messages.scrollTop = messages.scrollHeight;

      history.push({ role, text });
      if (history.length > 10) {
        history.shift();
      }
    };

    const appendTypingMessage = () => {
      if (!(messages instanceof HTMLElement)) return null;

      const wrap = createScopedElement("article", "msg-wrap msg-wrap-assistant");
      wrap.setAttribute("data-typing", "true");

      const avatar = createScopedElement("span", "msg-avatar msg-avatar-assistant");
      avatar.textContent = "IA";
      avatar.setAttribute("aria-hidden", "true");

      const stack = createScopedElement("div", "msg-stack");

      const roleLabel = createScopedElement("p", "msg-role");
      roleLabel.textContent = "Asistente";

      const bubble = createScopedElement("div", "msg msg-assistant msg-typing");
      for (let i = 0; i < 3; i += 1) {
        const dot = createScopedElement("span", "typing-dot");
        bubble.appendChild(dot);
      }

      stack.append(roleLabel, bubble);
      wrap.append(avatar, stack);
      messages.appendChild(wrap);
      messages.scrollTop = messages.scrollHeight;
      return wrap;
    };

    const clearPendingModalEffects = () => {
      if (openFrameId) {
        cancelAnimationFrame(openFrameId);
        openFrameId = 0;
      }
    };

    const setModalState = (open) => {
      if (!(modal instanceof HTMLElement) || !(trigger instanceof HTMLElement)) return;
      clearPendingModalEffects();

      if (open) {
        if (modal.classList.contains("is-open")) return;
        openFrameId = requestAnimationFrame(() => {
          openFrameId = 0;
          modal.classList.add("is-open");
          modal.setAttribute("aria-hidden", "false");
          trigger.setAttribute("aria-expanded", "true");
          document.body.style.overflow = "hidden";
          if (textarea instanceof HTMLTextAreaElement) textarea.focus();
        });
        return;
      }

      if (!modal.classList.contains("is-open")) return;
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
      trigger.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";
    };

    trigger?.addEventListener("click", () => setModalState(true));

    closeButtons.forEach((button) => {
      button.addEventListener("click", () => setModalState(false));
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && modal instanceof HTMLElement && modal.classList.contains("is-open")) {
        setModalState(false);
      }
    });

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!(textarea instanceof HTMLTextAreaElement) || !(sendButton instanceof HTMLButtonElement)) return;

      const message = textarea.value.trim();
      if (!message) return;

      appendMessage(message, "user");
      textarea.value = "";
      sendButton.disabled = true;
      if (status instanceof HTMLElement) status.textContent = "Respondiendo...";
      const typingNode = appendTypingMessage();

      try {
        const response = await fetch("/api/chat-humedal", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            history: history.slice(0, -1),
          }),
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(data?.error || "No fue posible responder tu consulta.");
        }

        appendMessage(data.answer || "No hubo respuesta.", "assistant");
        if (status instanceof HTMLElement) status.textContent = "";
      } catch (error) {
        const fallback = error instanceof Error ? error.message : "Ocurrio un error inesperado.";
        appendMessage(fallback, "assistant");
        if (status instanceof HTMLElement) status.textContent = "Error al consultar.";
      } finally {
        typingNode?.remove();
        sendButton.disabled = false;
        if (textarea instanceof HTMLTextAreaElement) textarea.focus();
      }
    });
  };

  const initChatWidgets = () => {
    document.querySelectorAll("[data-chat-widget]").forEach((widget) => {
      initChatWidget(widget);
    });
  };

  initChatWidgets();
  document.addEventListener("astro:page-load", initChatWidgets);
</script>
