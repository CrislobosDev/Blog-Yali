---
import { supabase } from "../../lib/supabaseClient";

const { data: featuredSetting, error: featuredError } = await supabase
  .from("site_settings")
  .select("value")
  .eq("key", "featured_gallery_limit")
  .maybeSingle();

if (featuredError) {
  console.error("Error al cargar límite de destacadas:", featuredError);
}

const featuredLimit = Math.max(1, Number(featuredSetting?.value) || 6);

const { data: fotos, error } = await supabase
  .from("imagenes")
  .select("id, url_publica, alt_text, descripcion, detalle, destacada_orden")
  .eq("destacada", true)
  .order("destacada_orden", { ascending: true, nullsFirst: false })
  .order("created_at", { ascending: false })
  .limit(featuredLimit);

if (error) {
  console.error("Error al cargar fotos destacadas:", error);
}

const fotosDestacadas = fotos ?? [];
---

<section class="pictures">
  <div class="container">
    <div class="title">
      <p class="kicker">Galería destacada</p>
      <h2>Fotografías del Yali</h2>
    </div>
    <div class="grid">
      {fotosDestacadas.length === 0 ? (
        <div class="empty">
          <p>Aún no hay fotos destacadas.</p>
          <p>Publica imágenes desde el panel para que aparezcan aquí.</p>
        </div>
      ) : (
        fotosDestacadas.map((foto) => (
          <figure>
            <img
              src={foto.url_publica}
              alt={foto.alt_text ?? "Fotografía del humedal"}
              loading="lazy"
            />
            <figcaption>
              {foto.descripcion ?? foto.alt_text ?? "Sin descripción"}
              {foto.detalle ? <span class="caption-detail">{foto.detalle}</span> : null}
            </figcaption>
          </figure>
        ))
      )}
    </div>
    <div class="cta">
      <a class="button" href="/galeria">Ver galería completa</a>
    </div>
  </div>
</section>

<style>
  .pictures {
    background: var(--paper-2);
    padding: 6rem 0;
  }

  .title {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .kicker {
    text-transform: uppercase;
    letter-spacing: 0.25rem;
    font-size: 0.8rem;
    margin: 0 0 0.5rem;
    color: var(--muted);
  }

  h2 {
    font-family: "Alegreya", serif;
    font-size: clamp(2rem, 3vw, 3rem);
    margin: 0;
  }

  .grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  figure {
    margin: 0;
    background: var(--paper);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  img {
    width: 100%;
    height: 220px;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  figure:hover img {
    transform: scale(1.05);
  }

  figcaption {
    padding: 0.9rem 1rem 1.1rem;
    font-size: 0.95rem;
    color: var(--muted);
  }

  .caption-detail {
    display: block;
    font-size: 0.85rem;
    color: rgba(89, 96, 88, 0.8);
    margin-top: 0.25rem;
  }

  .empty {
    background: var(--paper);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
    color: var(--muted);
    grid-column: 1 / -1;
  }

  .empty p {
    margin: 0 0 0.5rem;
  }

  .cta {
    margin-top: 2.5rem;
    display: flex;
    justify-content: center;
  }

  .button {
    background: var(--accent);
    color: white;
    border-radius: 999px;
    padding: 0.9rem 1.8rem;
    text-decoration: none;
    font-weight: 600;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(47, 107, 76, 0.25);
  }
</style>
