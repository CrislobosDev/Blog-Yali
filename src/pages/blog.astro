---
import Layout from "../layouts/Layout.astro";
import Header from "../components/ui/Header.astro";
import Footer from "../components/ui/Footer.astro";
import { supabase } from "../lib/supabaseClient";

const { data: posts, error } = await supabase
  .from("blog_posts")
  .select("id, title, excerpt, content, image_url, category, published_at")
  .order("published_at", { ascending: false });

if (error) {
  console.error("Error al cargar el blog:", error);
}

const blogPosts = posts ?? [];
---

<Layout title="Blog | Yali Salvaje">
  <Header />
  <section class="page">
    <div class="container">
      <p class="kicker">Noticias y curiosidades</p>
      <h1>Blog del Humedal</h1>
      <p class="lead">
        Aquí podrás encontrar artículos con imágenes y texto sobre flora, fauna
        y actividades de conservación. El contenido se publica desde el panel de
        administración.
      </p>

      <div class="grid">
        {
          blogPosts.length === 0 ? (
            <div class="empty">
              <p>Aún no hay entradas publicadas.</p>
              <p>Vuelve pronto para leer nuevas historias del humedal.</p>
            </div>
          ) : (
            blogPosts.map((post) => (
              <article
                class="card card-surface card-hover media-zoom"
                data-title={post.title}
                data-category={post.category ?? ""}
                data-excerpt={post.excerpt ?? ""}
                data-content={encodeURIComponent(post.content ?? "")}
                data-image={post.image_url ?? ""}
                data-date={post.published_at ?? ""}
              >
                {post.image_url && (
                  <div class="card-image">
                    <img
                      src={post.image_url}
                      alt={post.title}
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                )}
                <div class="card-body">
                  {post.category && <p class="tag">{post.category}</p>}
                  <h2>{post.title}</h2>
                  {post.excerpt && <p class="excerpt">{post.excerpt}</p>}
                  {post.published_at && (
                    <p class="date">
                      {new Date(post.published_at).toLocaleDateString("es-CL", {
                        day: "2-digit",
                        month: "long",
                        year: "numeric",
                      })}
                    </p>
                  )}
                </div>
              </article>
            ))
          )
        }
      </div>
      <div class="modal" id="blog-modal" aria-hidden="true">
        <div class="modal-overlay" id="modal-overlay"></div>
        <div
          class="modal-content"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-title"
        >
          <button class="modal-close" type="button" aria-label="Cerrar"
            >×</button
          >
          <div class="modal-hero">
            <img id="modal-image" alt="" />
          </div>
          <div class="modal-body">
            <p class="tag" id="modal-category"></p>
            <h2 id="modal-title"></h2>
            <p class="date" id="modal-date"></p>
            <p class="excerpt" id="modal-excerpt"></p>
            <div class="content" id="modal-content"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const modal = document.getElementById("blog-modal");
    const overlay = document.getElementById("modal-overlay");
    const modalImage = document.getElementById("modal-image");
    const modalTitle = document.getElementById("modal-title");
    const modalCategory = document.getElementById("modal-category");
    const modalDate = document.getElementById("modal-date");
    const modalExcerpt = document.getElementById("modal-excerpt");
    const modalContent = document.getElementById("modal-content");
    const closeButton = document.querySelector(".modal-close");

    const formatDate = (value) => {
      if (!value) return "";
      return new Date(value).toLocaleDateString("es-CL", {
        day: "2-digit",
        month: "long",
        year: "numeric",
      });
    };

    const escapeHtml = (value) =>
      value
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");

    const renderContent = (value) => {
      if (!value) return "";
      const escaped = escapeHtml(value);
      const paragraphs = escaped
        .split(/\n{2,}/)
        .map((block) => block.replace(/\n/g, "<br />"));
      return `<p>${paragraphs.join("</p><p>")}</p>`;
    };

    const openModal = (card) => {
      if (!modal) return;
      const title = card.getAttribute("data-title") || "";
      const category = card.getAttribute("data-category") || "";
      const excerpt = card.getAttribute("data-excerpt") || "";
      const contentRaw = card.getAttribute("data-content") || "";
      const content = contentRaw ? decodeURIComponent(contentRaw) : "";
      const image = card.getAttribute("data-image") || "";
      const date = card.getAttribute("data-date") || "";

      if (modalImage) {
        if (image) {
          modalImage.setAttribute("src", image);
          modalImage.setAttribute("alt", title);
          modalImage.style.display = "block";
        } else {
          modalImage.removeAttribute("src");
          modalImage.style.display = "none";
        }
      }

      if (modalTitle) modalTitle.textContent = title;
      if (modalCategory) {
        modalCategory.textContent = category;
        modalCategory.style.display = category ? "inline-block" : "none";
      }
      if (modalDate) modalDate.textContent = formatDate(date);
      if (modalExcerpt) modalExcerpt.textContent = excerpt;
      if (modalContent) modalContent.innerHTML = renderContent(content);

      modal.setAttribute("aria-hidden", "false");
      modal.classList.add("is-open");
      document.body.style.overflow = "hidden"; // Prevent scrolling
    };

    document.querySelectorAll(".card").forEach((card) => {
      card.addEventListener("click", () => openModal(card));
    });

    const closeModal = () => {
      if (!modal) return;
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = ""; // Restore scrolling
    };

    overlay?.addEventListener("click", closeModal);
    closeButton?.addEventListener("click", closeModal);

    const handleKeydown = (event) => {
      if (event.key === "Escape" && modal?.classList.contains("is-open"))
        closeModal();
    };
    document.addEventListener("keydown", handleKeydown);

    document.addEventListener(
      "astro:before-swap",
      () => {
        document.removeEventListener("keydown", handleKeydown);
        document.body.style.overflow = "";
      },
      { once: true },
    );
  });
</script>

<style>
  .page {
    padding: 7rem 0 6rem;
  }

  h1 {
    font-family: "Alegreya", serif;
    font-size: clamp(2.5rem, 4vw, 4rem);
    margin: 0 0 0.75rem;
  }

  h2 {
    font-family: "Alegreya", serif;
    font-size: 1.6rem;
    margin: 0 0 0.6rem;
  }

  .kicker {
    text-transform: uppercase;
    letter-spacing: 0.25rem;
    font-size: 0.8rem;
    color: var(--muted);
    margin: 0 0 0.5rem;
  }

  .lead {
    font-size: 1.1rem;
    max-width: 700px;
  }

  .grid {
    display: grid;
    gap: 1.75rem;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    margin-top: 2.5rem;
  }

  .card {
    display: grid;
    cursor: pointer;
  }

  .card-image img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .card-body {
    padding: 1.2rem 1.4rem 1.6rem;
    display: grid;
    gap: 0.5rem;
  }

  .tag {
    text-transform: uppercase;
    letter-spacing: 0.2rem;
    font-size: 0.7rem;
    color: var(--muted);
    margin: 0;
  }

  .excerpt {
    margin: 0;
    color: var(--muted);
  }

  .date {
    margin: 0;
    font-size: 0.9rem;
    color: var(--muted);
  }

  .empty {
    background: var(--paper);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
    color: var(--muted);
  }

  .empty p {
    margin: 0 0 0.5rem;
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: grid;
    place-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 2000;
    padding: 1rem;
    z-index: 3000;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    backdrop-filter: blur(4px);
  }

  .modal.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .modal-content {
    background: var(--paper);
    border-radius: 24px;
    max-width: 800px;
    position: relative;
    width: 100%;
    max-height: 85vh;
    overflow: auto;
    box-shadow: var(--shadow);
  }

  .modal-hero img {
    width: 100%;
    max-height: 320px;
    object-fit: cover;
    display: block;
  }

  .modal-body {
    padding: 2rem;
    display: grid;
    gap: 0.8rem;
  }

  .modal-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    font-size: 2rem;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    cursor: pointer;
  }

  .content {
    font-size: 1.05rem;
    line-height: 1.7;
    color: var(--text);
    white-space: pre-wrap;
  }
</style>
