---
import Layout from "../layouts/Layout.astro";
import Header from "../components/ui/Header.astro";
import Footer from "../components/ui/Footer.astro";
import { supabase } from "../lib/supabaseClient";

const { data: fotos, error } = await supabase
  .from("imagenes")
  .select("id, url_publica, alt_text, descripcion, detalle")
  .order("created_at", { ascending: false });

if (error) {
  console.error("Error al cargar la galería:", error);
}

const imagenesGaleria = fotos ?? [];
const INITIAL_BATCH_SIZE = 18;
const getVariantClass = (index) => {
  const mod = index % 12;
  if (mod === 0 || mod === 7) return "v-wide";
  if (mod === 2 || mod === 9) return "v-tall";
  if (mod === 4) return "v-feature";
  return "v-regular";
};
const imagenesIniciales = imagenesGaleria.slice(0, INITIAL_BATCH_SIZE);
const imagenesPayload = JSON.stringify(
  imagenesGaleria.map((foto, index) => ({
    id: foto.id,
    index,
    url: foto.url_publica,
    alt: foto.alt_text ?? "Fotografia del humedal",
    caption: foto.descripcion ?? foto.alt_text ?? "Sin descripcion",
    detail: foto.detalle ?? "",
  })),
);
---

<Layout title="Galería | Yali Salvaje">
  <Header />
  <section class="page">
    <div class="gallery-shell">
      <p class="kicker">Registro fotográfico</p>
      <h1>Galería del Humedal El Yali</h1>
      <p class="lead">Mural visual de gran formato con carga continua.</p>

      <div class="mosaic-gallery" id="gallery-grid">
        {
          imagenesGaleria.length === 0 ? (
            <div class="empty">
              <p>Aún no hay fotos en la galería.</p>
              <p>Muy pronto compartiremos nuevas capturas del humedal.</p>
            </div>
          ) : (
            imagenesIniciales.map((foto, index) => (
              <figure class={`foto-item ${getVariantClass(index)} media-zoom`} tabindex="0" role="button">
                <img
                  src={foto.url_publica}
                  alt={foto.alt_text ?? "Fotografía del humedal"}
                  loading="lazy"
                  data-full={foto.url_publica}
                  data-caption={
                    foto.descripcion ?? foto.alt_text ?? "Sin descripción"
                  }
                  data-detail={foto.detalle ?? ""}
                />
                <figcaption>
                  {foto.descripcion ?? foto.alt_text ?? "Sin descripción"}
                  {foto.detalle ? (
                    <span class="caption-detail">{foto.detalle}</span>
                  ) : null}
                </figcaption>
              </figure>
            ))
          )
        }
      </div>
      {
        imagenesGaleria.length > INITIAL_BATCH_SIZE ? (
          <div class="gallery-feed" id="gallery-feed">
            <p class="gallery-loading" id="gallery-loading">Cargando más fotografías...</p>
            <div class="gallery-sentinel" id="gallery-sentinel" aria-hidden="true"></div>
          </div>
        ) : null
      }

      <script type="application/json" id="gallery-data" set:html={imagenesPayload}></script>

      <div class="lightbox ui-modal" id="lightbox" aria-hidden="true">
        <div class="ui-modal-overlay" id="lightbox-overlay"></div>
        <div class="lightbox-panel ui-modal-panel">
          <button class="lightbox-close ui-modal-close" type="button" aria-label="Cerrar"
            >×</button
          >
          <button class="lightbox-prev" type="button" aria-label="Anterior"
            >‹</button
          >
          <button class="lightbox-next" type="button" aria-label="Siguiente"
            >›</button
          >
          <div class="lightbox-content">
            <img id="lightbox-image" alt="" />
            <div class="lightbox-meta">
              <p class="lightbox-title" id="lightbox-caption"></p>
              <p class="lightbox-hint">Desliza para cambiar de foto</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const galleryGrid = document.getElementById("gallery-grid");
    const rawData = document.getElementById("gallery-data")?.textContent || "[]";
    const allPhotos = JSON.parse(rawData);
    const initialCount = galleryGrid?.querySelectorAll(".foto-item").length ?? 0;
    let renderedCount = initialCount;
    const BATCH_SIZE = 12;
    const lightbox = document.getElementById("lightbox");
    const lightboxImage = document.getElementById("lightbox-image");
    const lightboxCaption = document.getElementById("lightbox-caption");
    const closeButton = document.querySelector(".lightbox-close");
    const prevButton = document.querySelector(".lightbox-prev");
    const nextButton = document.querySelector(".lightbox-next");
    const overlay = document.getElementById("lightbox-overlay");
    const sentinel = document.getElementById("gallery-sentinel");
    const loadingLabel = document.getElementById("gallery-loading");
    let currentIndex = -1;
    let touchStartX = 0;
    let touchStartY = 0;

    const getGalleryImages = () =>
      Array.from(document.querySelectorAll(".foto-item img"));

    const createCard = (foto) => {
      if (!(galleryGrid instanceof HTMLElement)) return;
      const figure = document.createElement("figure");
      const getVariantClass = (index) => {
        const mod = index % 12;
        if (mod === 0 || mod === 7) return "v-wide";
        if (mod === 2 || mod === 9) return "v-tall";
        if (mod === 4) return "v-feature";
        return "v-regular";
      };
      figure.className = `foto-item ${getVariantClass(foto.index || 0)} media-zoom`;
      figure.setAttribute("tabindex", "0");
      figure.setAttribute("role", "button");

      const img = document.createElement("img");
      img.src = foto.url;
      img.alt = foto.alt || "Fotografia del humedal";
      img.loading = "lazy";
      img.setAttribute("data-full", foto.url);
      img.setAttribute("data-caption", foto.caption || "Sin descripcion");
      img.setAttribute("data-detail", foto.detail || "");

      const figcaption = document.createElement("figcaption");
      figcaption.textContent = foto.caption || "Sin descripcion";
      if (foto.detail) {
        const detail = document.createElement("span");
        detail.className = "caption-detail";
        detail.textContent = foto.detail;
        figcaption.appendChild(detail);
      }

      figure.append(img, figcaption);
      galleryGrid.appendChild(figure);
    };

    const loadNextBatch = () => {
      if (renderedCount >= allPhotos.length) {
        if (loadingLabel instanceof HTMLElement) loadingLabel.style.display = "none";
        if (sentinel instanceof HTMLElement) sentinel.style.display = "none";
        return false;
      }

      const next = allPhotos.slice(renderedCount, renderedCount + BATCH_SIZE);
      next.forEach((foto) => createCard(foto));
      renderedCount += next.length;

      if (renderedCount >= allPhotos.length) {
        if (loadingLabel instanceof HTMLElement) loadingLabel.textContent = "Has visto toda la galería.";
      }
      return true;
    };

    const openLightbox = (img) => {
      if (!lightbox || !lightboxImage) return;
      const src = img.getAttribute("data-full") || img.src;
      const caption =
        img.getAttribute("data-caption") ||
        img.closest("figure")?.querySelector("figcaption")?.textContent ||
        img.getAttribute("alt") ||
        "";
      const detail = img.getAttribute("data-detail") || "";
      lightboxImage.setAttribute("src", src);
      lightboxImage.setAttribute("alt", img.alt || "");
      if (lightboxCaption) {
        lightboxCaption.textContent = detail
          ? `${caption} — ${detail}`
          : caption;
      }
      lightbox.setAttribute("aria-hidden", "false");
      lightbox.classList.add("is-open");
      currentIndex = getGalleryImages().indexOf(img);
      document.body.style.overflow = "hidden";
    };

    galleryGrid?.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const item = target.closest(".foto-item");
      const img = item?.querySelector("img");
      if (img instanceof HTMLImageElement) openLightbox(img);
    });

    galleryGrid?.addEventListener("keydown", (event) => {
      if (event.key !== "Enter" && event.key !== " ") return;
      const target = event.target;
      if (!(target instanceof HTMLElement) || !target.classList.contains("foto-item")) return;
      event.preventDefault();
      const img = target.querySelector("img");
      if (img instanceof HTMLImageElement) openLightbox(img);
    });

    const closeLightbox = () => {
      if (!lightbox) return;
      lightbox.classList.remove("is-open");
      lightbox.setAttribute("aria-hidden", "true");
      currentIndex = -1;
      document.body.style.overflow = "";
    };

    const showAtIndex = (index) => {
      const galleryImages = getGalleryImages();
      if (!galleryImages.length) return;
      const safeIndex = (index + galleryImages.length) % galleryImages.length;
      const img = galleryImages[safeIndex];
      if (!img) return;
      currentIndex = safeIndex;
      openLightbox(img);
    };

    overlay?.addEventListener("click", closeLightbox);

    closeButton?.addEventListener("click", closeLightbox);
    prevButton?.addEventListener("click", (e) => {
      e.stopPropagation();
      showAtIndex(currentIndex - 1);
    });
    nextButton?.addEventListener("click", (e) => {
      e.stopPropagation();
      showAtIndex(currentIndex + 1);
    });

    lightboxImage?.addEventListener("touchstart", (event) => {
      const touch = event.touches[0];
      if (!touch) return;
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
    });

    lightboxImage?.addEventListener("touchend", (event) => {
      const touch = event.changedTouches[0];
      if (!touch) return;
      const diffX = touch.clientX - touchStartX;
      const diffY = touch.clientY - touchStartY;
      if (Math.abs(diffX) < 40 || Math.abs(diffY) > 80) return;
      if (diffX > 0) showAtIndex(currentIndex - 1);
      else showAtIndex(currentIndex + 1);
    });

    const handleKeydown = (event) => {
      if (!lightbox || !lightbox.classList.contains("is-open")) return;
      if (event.key === "Escape") closeLightbox();
      if (event.key === "ArrowLeft") showAtIndex(currentIndex - 1);
      if (event.key === "ArrowRight") showAtIndex(currentIndex + 1);
    };

    document.addEventListener("keydown", handleKeydown);

    const observer =
      sentinel instanceof HTMLElement
        ? new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (!entry.isIntersecting) return;
                const loaded = loadNextBatch();
                if (!loaded) observer.disconnect();
              });
            },
            { rootMargin: "900px 0px 900px 0px" },
          )
        : null;

    if (observer && sentinel instanceof HTMLElement) observer.observe(sentinel);

    // Clean up event listener before next navigation
    document.addEventListener(
      "astro:before-swap",
      () => {
        document.removeEventListener("keydown", handleKeydown);
        observer?.disconnect();
        document.body.style.overflow = "";
      },
      { once: true },
    );
  });
</script>

<style>
  .page {
    padding: 6.2rem 0 5rem;
    background:
      radial-gradient(circle at 12% 0%, rgba(165, 210, 175, 0.25), transparent 38%),
      radial-gradient(circle at 88% 0%, rgba(190, 215, 245, 0.2), transparent 42%),
      #f6f8f5;
  }

  .gallery-shell {
    width: min(1600px, calc(100vw - 1rem));
    margin: 0 auto;
  }

  h1 {
    font-family: "Alegreya", serif;
    font-size: clamp(2.5rem, 4vw, 4rem);
    margin: 0 0 0.75rem;
  }

  .kicker {
    text-transform: uppercase;
    letter-spacing: 0.25rem;
    font-size: 0.8rem;
    color: var(--muted);
    margin: 0 0 0.5rem;
  }

  .lead {
    font-size: 1.1rem;
    max-width: 540px;
    margin: 0;
  }

  .mosaic-gallery {
    margin-top: 2rem;
    display: grid;
    gap: 0.75rem;
    grid-template-columns: repeat(12, minmax(0, 1fr));
    grid-auto-rows: 32px;
  }

  .foto-item {
    margin: 0;
    border-radius: 1rem;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid rgba(12, 24, 16, 0.08);
    box-shadow: 0 16px 30px rgba(18, 34, 25, 0.14);
    position: relative;
    display: grid;
    grid-template-rows: 1fr auto;
    background: #dce4da;
  }

  .foto-item.v-regular {
    grid-column: span 3;
    grid-row: span 8;
  }

  .foto-item.v-wide {
    grid-column: span 6;
    grid-row: span 9;
  }

  .foto-item.v-tall {
    grid-column: span 3;
    grid-row: span 12;
  }

  .foto-item.v-feature {
    grid-column: span 6;
    grid-row: span 12;
  }

  .foto-item img {
    width: 100%;
    height: 100%;
    min-height: 100%;
    object-fit: cover;
    display: block;
  }

  .foto-item figcaption {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    margin: 0;
    padding: 1rem 0.9rem 0.85rem;
    color: rgba(255, 255, 255, 0.94);
    font-size: 0.88rem;
    line-height: 1.35;
    background: linear-gradient(180deg, rgba(9, 15, 11, 0), rgba(9, 15, 11, 0.78) 62%);
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 3;
    overflow: hidden;
  }

  .caption-detail {
    display: none;
  }

  .gallery-feed {
    margin: 1.25rem 0 0;
    display: grid;
    justify-items: center;
  }

  .gallery-loading {
    margin: 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .gallery-sentinel {
    width: 100%;
    height: 2px;
  }

  .lightbox {
    padding: 1rem;
  }

  .lightbox-panel {
    width: min(100%, 900px);
    overflow: hidden;
    padding: 1rem 1rem 1.25rem;
    background: #0f1512;
    border-color: rgba(255, 255, 255, 0.08);
  }

  .lightbox-content {
    display: grid;
    gap: 1rem;
    align-items: center;
    justify-items: center;
    max-width: min(100%, 900px);
  }

  .lightbox img {
    width: 100%;
    max-height: 70vh;
    object-fit: contain;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    background: rgba(255, 255, 255, 0.04);
  }

  .lightbox-meta {
    background: rgba(255, 255, 255, 0.08);
    padding: 0.75rem 1.25rem;
    border-radius: var(--radius-md);
    text-align: center;
  }

  .lightbox-title {
    color: #ffffff;
    font-size: 1.1rem;
    letter-spacing: 0.02em;
    margin: 0;
  }

  .lightbox-hint {
    margin: 0.35rem 0 0;
    color: rgba(255, 255, 255, 0.72);
    font-size: 0.8rem;
    letter-spacing: 0.03em;
  }

  @media (min-width: 900px) {
    .lightbox-content {
      grid-template-columns: 1fr;
    }

    .lightbox-title {
      font-size: 1.25rem;
    }
  }

  .lightbox-close {
    color: #101714;
  }

  .lightbox-prev,
  .lightbox-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: var(--text);
    font-size: 2.4rem;
    width: 56px;
    height: 56px;
    border-radius: var(--radius-round);
    cursor: pointer;
    z-index: 2;
  }

  .lightbox-prev {
    left: 0.75rem;
  }

  .lightbox-next {
    right: 0.75rem;
  }

  @media (max-width: 768px) {
    .lightbox {
      padding: 0.4rem;
    }

    .lightbox-panel {
      padding: 0.6rem 0.6rem 0.9rem;
    }

    .lightbox img {
      max-height: 62vh;
      border-radius: var(--radius-md);
    }

    .lightbox-prev,
    .lightbox-next {
      display: none;
    }
  }

  @media (min-width: 769px) {
    .lightbox-hint {
      display: none;
    }
  }

  .empty {
    background: var(--paper);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
    color: var(--muted);
    grid-column: 1 / -1;
  }

  .empty p {
    margin: 0 0 0.5rem;
  }

  @media (max-width: 1100px) {
    .foto-item.v-regular,
    .foto-item.v-tall {
      grid-column: span 4;
    }

    .foto-item.v-wide,
    .foto-item.v-feature {
      grid-column: span 8;
    }
  }

  @media (max-width: 780px) {
    .gallery-shell {
      width: min(100vw, calc(100vw - 0.4rem));
    }

    .mosaic-gallery {
      gap: 0.5rem;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-auto-rows: 28px;
    }

    .foto-item.v-regular,
    .foto-item.v-tall,
    .foto-item.v-wide,
    .foto-item.v-feature {
      grid-column: span 1;
    }

    .foto-item.v-regular {
      grid-row: span 9;
    }

    .foto-item.v-wide {
      grid-row: span 10;
    }

    .foto-item.v-tall {
      grid-row: span 12;
    }

    .foto-item.v-feature {
      grid-row: span 11;
    }
  }
</style>
